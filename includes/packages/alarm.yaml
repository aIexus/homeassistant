home_alarm_settings:

    alarm_control_panel:

        - platform: manual
          name: Home Alarm
          code: !secret alarm_panel_code
          code_arm_required: false    # Don't need code to arm.
          disarm_after_trigger: false # Leave alarm armed after triggering.
          arming_time: 30             # Time to leave the house after arming.
          delay_time: 60              # Time to turn off after entering the house.
          trigger_time: 600           # How long the alarm goes off for.
          disarmed:
            trigger_time: 0           # Can't be triggered when disarmed.
          armed_home:
            arming_time: 0            # Arm instantly when at home.
            delay_time: 0             # Trigger instantly when at home.

    automation:

        - alias: "Alarm: Triggers in ARMED_AWAY mode"
          id: alarm_triggers_armed_away
          description: 'Срабатывание триггеров при статусе охраны Armed_Away'
          trigger:
            - platform: state
              entity_id: binary_sensor.hallway_entrance_door_contact
              from: 'off'
              to: 'on'
            # - platform: state
            #   entity_id: binary_sensor.bedroom_lumi_sensor_motion_occupancy
            #   from: 'off'
            #   to: 'on'
            # - platform: state
            #   entity_id: binary_sensor.living_room_lumi_sensor_motion_occupancy
            #   from: 'off'
            #   to: 'on'
            # - platform: state
            #   entity_id: binary_sensor.tapo_camera_motion
            #   from: 'off'
            #   to: 'on'
          condition:
            - condition: state
              entity_id: alarm_control_panel.home_alarm
              state: 'armed_away'
          action:
            # define variables
            - variables:
                trigger_area_name: "{{ area_name(trigger.entity_id) }}"
                snapshot_file_name: |
                  {{ "/config/files/camera/" + state_attr('camera.tapo_camera_hd', 'friendly_name') +  "/snapshot_" + now().strftime('%Y%m%d-%H%M%S') + ".jpg" }}
                record_file_name: |
                  {{ "/config/files/camera/" + state_attr('camera.tapo_camera_hd', 'friendly_name') +  "/record_" + now().strftime('%Y%m%d-%H%M%S') + ".mp4" }}
            # trigger alarm
            - service: alarm_control_panel.alarm_trigger
              entity_id: alarm_control_panel.home_alarm
            # camera positioning
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ trigger_area_name == 'Hallway' }}"
                  sequence:
                    - service: script.tapo_camera_select_preset
                      data:
                        tapo_camera_id: camera.tapo_camera_hd
                        preset_name: 'Entrance'
                - conditions:
                    - condition: template
                      value_template: "{{ trigger_area_name == 'Bedroom' }}"
                  sequence:
                    - service: script.tapo_camera_select_preset
                      data:
                        tapo_camera_id: camera.tapo_camera_hd
                        preset_name: 'Bedroom'
                - conditions:
                    - condition: template
                      value_template: "{{ trigger_area_name == 'Living Room' }}"
                  sequence:
                    - service: script.tapo_camera_select_preset
                      data:
                        tapo_camera_id: camera.tapo_camera_hd
                        preset_name: 'Living Room'
            # notification about alarm triggering
            - service: notify.alexus
              data:
                title: '{{"\U000026A0"}} ВНИМАНИЕ{{"\U0000203C"}}'
                message: |
                    ➖➖➖➖➖➖➖➖➖➖➖➖
                    {{"\U0001F6A8"}} Сработала сигнализация{{"\U0000203C"}}
                    Триггер: {{ trigger.to_state.attributes.friendly_name }}
                    Пространство:  {{ trigger_area_name }} 
                    Время: {{ states('sensor.date') }}, {{ states('sensor.time') }}
            # take snapshot from detected area
            - service: script.tapo_camera_save_snapshot
              data:
                tapo_camera_id: camera.tapo_camera_hd
                file_name: '{{ snapshot_file_name }}'
            # send snapshot to alexus mobile/telegram
            - service: notify.alexus
              data:
                message: '{{ trigger_area_name }}'
                data:
                  photo:
                    - file: '{{ snapshot_file_name }}'
                      caption: 'Фото: {{ trigger_area_name }}'
            # record short video from detected area
            - service: script.tapo_camera_save_record
              data:
                tapo_camera_id: camera.tapo_camera_hd
                file_name: '{{ record_file_name }}'
                time_duration: 15
            - service: notify.alexus
              data:
                message: '{{ trigger_area_name }}'
                data:
                  video:
                    - file: '{{ record_file_name }}'
                      caption: 'Видео: {{ trigger_area_name }}'
          mode: single

        - alias: "Alarm: Triggers in ARMED_HOME mode"
          id: alarm_triggers_armed_home
          description: 'Определение триггеров при статусе охраны Armed_Home'
          trigger:
            - platform: state
              entity_id: binary_sensor.hallway_entrance_door_contact
              from: 'off'
              to: 'on'
          condition:
            - condition: state
              entity_id: alarm_control_panel.home_alarm
              state: 'armed_home'
          action:
            - service: alarm_control_panel.alarm_trigger
              entity_id: alarm_control_panel.home_alarm
          mode: single

        - alias: "Alarm: Actions when ARMED_HOME"
          id: alarm_armed_home
          description: 'Постановка на сигнализацию Armed_Home'
          trigger:
            - platform: state
              entity_id: alarm_control_panel.home_alarm
              to: 'armed_home'
          action:
            - choose: # time condition
                - conditions:
                    - condition: time
                      after:  '08:00:00'
                      before: '22:00:00' 
                  sequence:
                    - service: script.sonos_play_file
                      data: 
                        sonos_entity: media_player.sonos_living_room
                        volume: 0.7
                        music_file: '/media/local/alerts/Car_Arm.mp3'
                    - service: light.turn_on
                      target:
                        entity_id: light.hallway_rgb_bulb
                      data: 
                        brightness: 100
                        rgb_color: [255, 254, 72]
                - conditions:
                    - condition: time
                      before:  '08:00:00'
                      after: '22:00:00' 
                  sequence:
                    - service: light.turn_on
                      target:
                        entity_id: light.hallway_rgb_bulb
                      data: 
                        brightness: 13
                        rgb_color: [5, 69, 255]
            - service: notify.alexus
              data:
                title: '{{"\U0001F6A8"}} СИГНАЛИЗАЦИЯ{{"\U0000203C"}}'
                message: |
                    ➖➖➖➖➖➖➖➖➖➖➖➖
                    {{"\U0001F694"}} Постановка на сигнализацию{{"\U0000203C"}}
                    {{"\U0001F550"}} {{ states('sensor.date') }}, {{ states('sensor.time') }}
                data: 
                  inline_keyboard: 
                    - "{{'\U0001F694'}} Снять с охраны {{'\U0001F7E1'}} [ Дома ]:/cancel_alarm"
                    - "{{'\U0001F6E1'}} Безопасность:/security, {{'\U0001F4D1'}}Меню:/menu"
          mode: single

        - alias: "Alarm: Actions when ARMED_AWAY"
          id: alarm_armed_away
          description: 'Постановка на сигнализацию Armed_Away'
          trigger:
            - platform: state
              entity_id: alarm_control_panel.home_alarm
              to: 'armed_away'
          action:
            - choose:
                - conditions:
                    - condition: time
                      after:  '08:00:00'
                      before: '22:00:00' 
                  sequence:
                    - service: script.sonos_play_file
                      data: 
                        sonos_entity: media_player.sonos_living_room
                        volume: 0.7
                        music_file: '/media/local/alerts/Car_Arm.mp3'
            - service: notify.alexus
              data:
                title: '{{"\U0001F6A8"}} СИГНАЛИЗАЦИЯ{{"\U0000203C"}}'
                message: |
                    ➖➖➖➖➖➖➖➖➖➖➖➖
                    {{"\U0001F694"}} Постановка на сигнализацию{{"\U0000203C"}}
                    {{"\U0001F550"}} {{ states('sensor.date') }}, {{ states('sensor.time') }}
                data: 
                  inline_keyboard: 
                    - "{{'\U0001F694'}} Снять с охраны {{'\U0001F534'}} [Не Дома]:/cancel_alarm"
                    - "{{'\U0001F6E1'}} Безопасность:/security, {{'\U0001F4D1'}} Меню:/menu"
            - choose:
                - conditions:
                    - condition: state
                      entity_id: input_boolean.tapo_camera_privacy_mode
                      state: 'on'
                  sequence:
                    - service: input_boolean.turn_off
                      entity_id: input_boolean.tapo_camera_privacy_mode
                    - delay: '00:00:06'
                    - service: script.tapo_camera_select_preset
                      data:
                        tapo_camera_id: camera.tapo_camera_sd
                        preset_name: 'Entrance'
          mode: single

        - alias: "Alarm: Actions when DISARMED"
          id: alarm_disarmed
          description: 'Снятие с охраны'
          trigger:
            - platform: state
              entity_id: alarm_control_panel.home_alarm
              to: 'disarmed'
          action:
            - service: script.turn_on
              target:
                entity_id: script.rgb_bulb_flashing_x_times
              data:
                variables:
                  rgb_bulb_entity_id: light.hallway_rgb_bulb
                  count: 2
                  color: 'green'
            - choose:
                - conditions:
                    - condition: time
                      after:  '08:00:00'
                      before: '22:00:00' 
                  sequence:
                    - service: script.sonos_play_file
                      data: 
                        sonos_entity: media_player.sonos_living_room
                        volume: 0.7
                        music_file: '/media/local/alerts/Car_Alarm_Disarm.mp3'
            - service: notify.alexus
              data:
                title: '{{"\U0001F6A8"}} СИГНАЛИЗАЦИЯ{{"\U0000203C"}}'
                message: |
                    ➖➖➖➖➖➖➖➖➖➖➖➖
                    {{"\U0001F694"}} Сигнализация отключена{{"\U0000203C"}}{{"\U0000203C"}}
                    {{"\U0001F550"}} {{ states('sensor.date') }}, {{ states('sensor.time') }}
                    
                    Включить сигнализацию{{"\U00002049"}}
                data: 
                  inline_keyboard: 
                    - "{{'\U0001F534'}} Не Дома:/set_alarm_away, {{'\U0001F7E1'}} Дома:/set_alarm_home"
                    - "{{'\U0001F6E1'}} Безопасность:/security, {{'\U0001F4D1'}} Меню:/menu"
            - choose:
                - conditions:
                    - condition: state
                      entity_id: input_boolean.tapo_camera_privacy_mode
                      state: 'off'
                  sequence:
                    - service: script.tapo_camera_select_preset
                      data:
                        tapo_camera_id: camera.tapo_camera_sd
                        preset_name: 'Entrance'
                    - service: input_boolean.turn_on
                      entity_id: input_boolean.tapo_camera_privacy_mode
                    - delay: '00:00:06'
            - wait_template: |
                {{ is_state('script.rgb_bulb_flashing_while_condition', 'off') and 
                   is_state('script.rgb_bulb_flashing_x_times', 'off')
                }}
            # - service: scene.turn_on
            #   entity_id: scene.scene_rgb_bulb_white
            # - delay: '00:00:01'
            - choose:
                - conditions:
                    - condition: state
                      entity_id: light.hallway_rgb_bulb
                      state: 'on'
                  sequence:
                    - service: light.turn_off
                      entity_id: light.hallway_rgb_bulb
          mode: single

        - alias: "Alarm: Set ARMED_HOME if anyone home at 22:00"
          id: alarm_auto_arm_if_anyone_home
          description: 'Автоматическая поставновка на охрану после 22:00, если дома кто-то есть'
          trigger:
            - platform: time
              at: '22:00:00'
          condition:
            - condition: state
              entity_id: group.family
              state: home
            - condition: state
              entity_id: alarm_control_panel.home_alarm
              state: 'disarmed'
          action:
            - service: alarm_control_panel.alarm_arm_home
              entity_id: alarm_control_panel.home_alarm
          mode: single

        - alias: "Alarm: Set DISARMED if anyone home at 5:30"
          id: alarm_auto_disarm_if_anyone_home
          description: 'Автоматическое снятие с охраны после 05:30, если дома кто-то есть'
          trigger:
            - platform: time
              at: '05:30:00'
          condition:
            - condition: state
              entity_id: group.family
              state: home
          action:
            - service: alarm_control_panel.alarm_disarm
              data: 
                code: !secret alarm_panel_code
              entity_id: alarm_control_panel.home_alarm
          mode: single

        - alias: "Alarm: Actions on TRIGGERED"
          id: alarm_triggered
          description: 'Сработала сигнализация, включение сирены'
          trigger:
            - platform: state
              entity_id: alarm_control_panel.home_alarm
              to: 'triggered'
          action:
            - variables:
                speaker_volume: 0.7
            - service: notify.alexus
              data:
                title: '{{"\U0001F6A8"}} СИГНАЛИЗАЦИЯ{{"\U0000203C"}}'
                message: |
                    ➖➖➖➖➖➖➖➖➖➖➖➖
                    {{"\U0001F694"}} Обнаружено проникновение{{"\U0000203C"}}{{"\U0000203C"}}
                    {{"\U0001F550"}} {{ states('sensor.date') }}, {{ states('sensor.time') }}
                data: 
                  inline_keyboard: 
                    - "{{'\U0001F694'}} Снять с охраны {{'\U0001F6A8'}} [ТРЕВОГА]:/cancel_alarm"
                    - "{{'\U0001F6E1'}} Безопасность:/security, {{'\U0001F4D1'}} Меню:/menu"
            - service: script.turn_on
              target:
                entity_id: script.rgb_bulb_flashing_while_condition
              data:
                variables:
                  rgb_bulb_entity_id: light.hallway_rgb_bulb
                  condition_entity_id: alarm_control_panel.home_alarm
                  repeat_while_state: 'triggered'
                  color: 'red'
            - repeat:
                until: 
                  - condition: state
                    entity_id: alarm_control_panel.home_alarm
                    state: 'disarmed'
                sequence:
                    - service: script.sonos_say
                      data: 
                        sonos_entity: media_player.sonos_living_room
                        volume: '{{ speaker_volume }}'
                        message: 'ВНИМАНИЕ! Сработала охранная сигнализация! Сообщение в полицию отправлено!'
                    - condition: state
                      entity_id: alarm_control_panel.home_alarm
                      state: 'triggered'
                    - service: script.sonos_play_file
                      data: 
                        sonos_entity: media_player.sonos_living_room
                        volume: '{{ speaker_volume }}'
                        music_file: '/media/local/alerts/Car_Alarm_02.mp3'
          mode: single

        - alias: "Alarm: Actions on ARMING"
          id: alarm_arming_signal
          description: 'Звук таймера перед активацией сигнализации'
          trigger:
            - platform: state
              entity_id: alarm_control_panel.home_alarm
              from: 'disarmed'
              to: 'arming'
          action:
            - service: script.turn_on
              target:
                entity_id: script.rgb_bulb_flashing_while_condition
              data:
                variables:
                  rgb_bulb_entity_id: light.hallway_rgb_bulb
                  condition_entity_id: alarm_control_panel.home_alarm
                  repeat_while_state: 'arming'
                  color: 'yellow'
            - repeat:
                until: 
                  - condition: or
                    conditions:
                      - condition: state
                        entity_id: alarm_control_panel.home_alarm
                        state: 'disarmed'
                      - condition: state
                        entity_id: alarm_control_panel.home_alarm
                        state: 'armed_away'
                sequence:
                  - service: script.sonos_play_file
                    data: 
                      sonos_entity: media_player.sonos_living_room
                      volume: 0.5
                      music_file: '/media/local/alerts/elearning-clock-ticking.mp3'

        - alias: "Alarm: Actions on PENDING after ARMED_AWAY"
          id: alarm_pending_armed_away
          description: 'Проникновение: Предупреждение и ожидание снятия с охраны'
          trigger:
            - platform: state
              entity_id: alarm_control_panel.home_alarm
              from: 'armed_away'
              to: 'pending'
          action:
            - variables:
                speaker_volume: 0.7
            - service: notify.alexus
              data:
                title: '{{"\U0001F6A8"}} СИГНАЛИЗАЦИЯ{{"\U0000203C"}}'
                message: |
                    ➖➖➖➖➖➖➖➖➖➖➖➖
                    Снимите систему с охраны СЕЙЧАС, если Вы хотите предотвратить активацию сирены!
                data: 
                  inline_keyboard: 
                    - "{{'\U0001F694'}} Снять с охраны {% if (trigger.from_state.state == 'armed_away') %}{{'\U0001F534'}} [Не Дома]{% elif (trigger.from_state.state == 'armed_home') %}{{'\U0001F7E1'}} [ Дома ]{% endif%}:/cancel_alarm"
                    - "{{'\U0001F6E1'}} Безопасность:/security, {{'\U0001F4D1'}} Меню:/menu"
            - service: script.turn_on
              target:
                entity_id: script.rgb_bulb_flashing_while_condition
              data:
                variables:
                  rgb_bulb_entity_id: light.hallway_rgb_bulb
                  condition_entity_id: alarm_control_panel.home_alarm
                  repeat_while_state: 'pending'
                  color: 'yellow'
            - repeat:
                until: 
                  - condition: or
                    conditions:
                      - condition: state
                        entity_id: alarm_control_panel.home_alarm
                        state: 'disarmed'
                      - condition: state
                        entity_id: alarm_control_panel.home_alarm
                        state: 'triggered'
                sequence:
                  - service: script.sonos_say
                    data: 
                      sonos_entity: media_player.sonos_living_room
                      volume: '{{ speaker_volume }}'
                      message: 'ПРЕДУПРЕЖДЕНИЕ! Снимите систему с охраны СЕЙЧАС, если Вы хотите предотвратить активацию сирены!!'
                  - condition: state
                    entity_id: alarm_control_panel.home_alarm
                    state: 'pending'
                  - service: script.sonos_play_file
                    data: 
                      sonos_entity: media_player.sonos_living_room
                      volume: '{{ speaker_volume }}'
                      music_file: '/media/local/alerts/Count_Down_01.mp3'
          mode: single

        - alias: "Alarm: Suggest ARMING when everybody leaves home"
          id: alarm_suggest_arming_when_everybody_leaves_home
          description: "Предложение поставить на охрану когда все покинули дом"
          trigger:
            - platform: state
              entity_id: group.family
              to: not_home
          condition:
            - condition: state
              entity_id: alarm_control_panel.home_alarm
              state: disarmed
          action:
            - service: notify.alexus
              data:
                title: '{{"\U0001F6A8"}} СИГНАЛИЗАЦИЯ{{"\U0000203C"}}'
                message: |
                    ➖➖➖➖➖➖➖➖➖➖➖➖
                    {{"\U0001F3E1"}} Никого нет дома{{"\U0000203C"}}
                    {{"\U0001F550"}} {{ states('sensor.date') }}, {{ states('sensor.time') }}
                    
                    {{"\U0001F694"}} Включить сигнализацию{{"\U00002049"}}
                data: 
                  inline_keyboard: 
                    - "{{'\U0001F534'}} Не Дома:/set_alarm_away, {{'\U0001F7E1'}} Дома:/set_alarm_home"
                    - "{{'\U0001F6E1'}} Безопасность:/security, {{'\U0001F4D1'}} Меню:/menu"
          mode: single

        - alias: "Alarm: Suggest ARMED_AWAY if nobody home at 23:00"
          id: alarm_suggest_arming_away_if_nobody_home_in_the_evening
          description: "Предложение поставить на охрану(не дома) когда никого нет дома поздно вечером"
          trigger:
            - platform: time
              at: '23:00:00'
          condition:
            - condition: state
              entity_id: group.family
              state: not_home
            - condition: state
              entity_id: alarm_control_panel.home_alarm
              state: disarmed
          action:
            - service: notify.alexus
              data:
                title: '{{"\U0001F6A8"}} СИГНАЛИЗАЦИЯ{{"\U0000203C"}}'
                message: |
                    ➖➖➖➖➖➖➖➖➖➖➖➖
                    {{"\U0001F3E1"}} Уже поздно и никого нет дома{{"\U0000203C"}}
                    {{"\U0001F550"}} {{ states('sensor.date') }}, {{ states('sensor.time') }}
                    
                    {{"\U0001F694"}} Включить сигнализацию{{"\U00002049"}}
                data: 
                  inline_keyboard: 
                    - "{{'\U0001F534'}} Установить на Охрана(Не Дома):/set_alarm_away"
                    - "{{'\U0001F6E1'}} Безопасность:/security, {{'\U0001F4D1'}} Меню:/menu"
          mode: single

        - alias: "Alarm: ARMING by Smart Button"
          id: alarm_arming_by_smart_button
          description: 'Установка на охрану: не дома - один клик, дома - долгое нажатие'
          trigger:
            - platform: state
              entity_id: sensor.tuya_smart_button_action
              attribute: action
              not_to: double
          condition:
            - condition: state
              entity_id: alarm_control_panel.home_alarm
              state: disarmed
          action:
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ trigger.to_state.attributes.action == 'single' }}"
                  sequence:
                    - service: alarm_control_panel.alarm_arm_away
                      entity_id: alarm_control_panel.home_alarm
                - conditions:
                    - condition: template
                      value_template: "{{ trigger.to_state.attributes.action == 'hold' }}"
                  sequence:
                    - service: alarm_control_panel.alarm_arm_home
                      entity_id: alarm_control_panel.home_alarm
          mode: single

        - alias: "Alarm: DISARMING by Smart Button"
          id: alarm_disarming_by_smart_button
          description: 'Снятие с охраны двойным нажатием'
          trigger: 
            - platform: state
              entity_id: sensor.hallway_rgb_bulb_switch_action
              attribute: action
              to: double 
            - platform: state
              entity_id: sensor.tuya_smart_button_action
              attribute: action
              to: double 
          condition:
            - condition: not
              conditions:
                - condition: state
                  entity_id: alarm_control_panel.home_alarm
                  state: disarmed
          action:
            - service: alarm_control_panel.alarm_disarm
              entity_id: alarm_control_panel.home_alarm
              data: 
                code: !secret alarm_panel_code
          mode: single
